<!DOCTYPE html>
<html>
<head>
    <title>Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #chat-box { height: 450px; overflow-y: auto; }
        .message { max-width: 70%; font-size: 14px; }
        .tick { font-size: 12px; color: gray; margin-left: 4px; }
    </style>
</head>
<body class="bg-light">

<div class="container py-4" style="max-width:700px;">

 <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="mb-0">Chat with {{ receiver.username }}</h6>
        <a href="{% url 'user_list' %}" class="btn btn-sm btn-outline-secondary">Back</a>
    </div>

    <div id="chat-box" class="bg-white border rounded p-3 mb-3">
        {% for msg in messages %}
        <div class="d-flex mb-2 {% if msg.sender == request.user %}justify-content-end{% endif %}">
            <div class="message px-3 py-2 rounded
                {% if msg.sender == request.user %}bg-success-subtle text-end{% else %}bg-secondary-subtle{% endif %}">
                {{ msg.content }}
                {% if msg.sender == request.user %}
                    <span class="tick">{% if msg.is_read %}✓✓{% else %}✓{% endif %}</span>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="input-group">
        <input id="msg" class="form-control">
        <button class="btn btn-primary" onclick="send()">Send</button>
    </div>
</div>

<script>
const chatBox = document.getElementById("chat-box");
chatBox.scrollTop = chatBox.scrollHeight;

const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
const socket = new WebSocket(
    protocol + window.location.host + "/ws/chat/{{ receiver.id }}/"
);

window.addEventListener("beforeunload", () => {
    if (socket.readyState === WebSocket.OPEN) socket.close();
});

socket.onmessage = function (e) {
    const data = JSON.parse(e.data);

    if (data.type === "read") {
        const ticks = document.querySelectorAll(".tick");
        if (ticks.length > 0) {
            ticks[ticks.length - 1].innerText = "✓✓";
        }
        return;
    }

    const wrapper = document.createElement("div");
    wrapper.classList.add("d-flex", "mb-2");

    const bubble = document.createElement("div");
    bubble.classList.add("message", "px-3", "py-2", "rounded");

    if (data.sender_id == "{{ request.user.id }}") {
        wrapper.classList.add("justify-content-end");
        bubble.classList.add("bg-success-subtle", "text-end");
        bubble.innerHTML = data.message + " <span class='tick'>✓</span>";
    } else {
        wrapper.classList.add("justify-content-start");
        bubble.classList.add("bg-secondary-subtle");
        bubble.innerHTML = data.message;
    }

    wrapper.appendChild(bubble);
    chatBox.appendChild(wrapper);
    chatBox.scrollTop = chatBox.scrollHeight;
};

function send() {
    const input = document.getElementById("msg");
    const text = input.value.trim();
    if (!text) return;

    socket.send(JSON.stringify({ message: text }));
    input.value = "";
}

document.getElementById("msg").addEventListener("keydown", function (e) {
    if (e.key === "Enter") {
        e.preventDefault();
        send();
    }
});
</script>

</body>
</html>