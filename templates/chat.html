<!DOCTYPE html>
<html>
<head>
    <title>Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #chat-box { height: 450px; overflow-y: auto; }
        .message { max-width: 70%; font-size: 14px; }
        .tick { font-size: 12px; color: gray; margin-left: 4px; }
    </style>
</head>
<body class="bg-light">

<div class="container py-4" style="max-width:700px;">

    <h6>Chat with {{ receiver.username }}</h6>

    <div id="chat-box" class="bg-white border rounded p-3 mb-3">
        {% for msg in messages %}
        <div class="d-flex mb-2 {% if msg.sender == request.user %}justify-content-end{% endif %}">
            <div class="message px-3 py-2 rounded
                {% if msg.sender == request.user %}bg-success-subtle text-end{% else %}bg-secondary-subtle{% endif %}">
                {{ msg.content }}
                {% if msg.sender == request.user %}
                    <span class="tick">{% if msg.is_read %}✓✓{% else %}✓{% endif %}</span>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="input-group">
        <input id="msg" class="form-control">
        <button class="btn btn-primary" onclick="send()">Send</button>
    </div>
</div>

<script>
const chatBox = document.getElementById("chat-box");
chatBox.scrollTop = chatBox.scrollHeight;

const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
const socket = new WebSocket(
    protocol + window.location.host + "/ws/chat/{{ receiver.id }}/"
);

window.addEventListener("beforeunload", () => socket.close());

socket.onmessage = function(e) {
    const data = JSON.parse(e.data);

    if (data.type === "read") {
        document.querySelectorAll(".tick").forEach(t => t.innerText = "✓✓");
        return;
    }

    const wrap = document.createElement("div");
    wrap.classList.add("d-flex", "mb-2");

    const bubble = document.createElement("div");
    bubble.classList.add("message", "px-3", "py-2", "rounded");

    if (data.sender_id == "{{ request.user.id }}") {
        wrap.classList.add("justify-content-end");
        bubble.classList.add("bg-success-subtle", "text-end");
        bubble.innerHTML = data.message + " <span class='tick'>✓</span>";
    } else {
        bubble.classList.add("bg-secondary-subtle");
        bubble.innerHTML = data.message;
    }

    wrap.appendChild(bubble);
    chatBox.appendChild(wrap);
    chatBox.scrollTop = chatBox.scrollHeight;
};

function send() {
    const input = document.getElementById("msg");
    if (!input.value.trim()) return;
    socket.send(JSON.stringify({ message: input.value }));
    input.value = "";
}
</script>

</body>
</html>